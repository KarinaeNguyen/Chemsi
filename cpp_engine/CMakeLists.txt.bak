cmake_minimum_required(VERSION 3.20)project(CHEMSI LANGUAGES CXX)set(CMAKE_CXX_STANDARD 17)set(CMAKE_CXX_STANDARD_REQUIRED ON)set(CMAKE_EXPORT_COMPILE_COMMANDS ON)# ============================================================# Build options# ============================================================# The visualizer pulls GUI dependencies (OpenGL/GLFW/ImGui/ImPlot). Make it# optional so a "core simulation" build works out-of-the-box.option(CHEMSI_BUILD_VIS "Build CHEMSI visualizer (GLFW/OpenGL/ImGui)" OFF)option(CHEMSI_ENABLE_GRPC "Enable Unity integration via gRPC + Protobuf" ON)option(CHEMSI_USE_SYSTEM_GRPC "Prefer system-installed gRPC/Protobuf instead of FetchContent" ON)# ============================================================# Core library# ============================================================add_library(chemsi  src/chemistry.cpp  src/LiIonRunaway.cpp  src/ObjectModel.cpp  src/MechanicsSim.cpp  src/GrpcSimServer.cpp  src/Reactor.cpp  src/Simulation.cpp  src/Aerodynamics.cpp  src/Suppression.cpp  src/Ventilation.cpp)target_include_directories(chemsi PUBLIC ${CMAKE_SOURCE_DIR}/include)# ============================================================# gRPC + Protobuf (Unity integration)# ============================================================if (CHEMSI_ENABLE_GRPC)  if (CHEMSI_USE_SYSTEM_GRPC)    # Use system-installed packages (recommended on Windows when using MSYS2/vcpkg).    find_package(Protobuf CONFIG REQUIRED)    find_package(gRPC CONFIG REQUIRED)  else()    # Fall back to FetchContent (downloads/builds gRPC + Protobuf).    include(FetchContent)    set(gRPC_INSTALL OFF CACHE BOOL "" FORCE)    set(gRPC_BUILD_TESTS OFF CACHE BOOL "" FORCE)    set(protobuf_BUILD_TESTS OFF CACHE BOOL "" FORCE)    set(protobuf_WITH_ZLIB OFF CACHE BOOL "" FORCE)    FetchContent_Declare(      grpc      GIT_REPOSITORY https://github.com/grpc/grpc.git      GIT_TAG        v1.62.2    )    FetchContent_MakeAvailable(grpc)  endif()  # Resolve the gRPC C++ plugin target name (varies by packaging).  set(CHEMSI_GRPC_CPP_PLUGIN_TARGET "")  set(CHEMSI_GRPC_CPP_PLUGIN_EXE "")  if (TARGET grpc_cpp_plugin)    set(CHEMSI_GRPC_CPP_PLUGIN_TARGET grpc_cpp_plugin)    set(CHEMSI_GRPC_CPP_PLUGIN_EXE $<TARGET_FILE:grpc_cpp_plugin>)  elseif (TARGET gRPC::grpc_cpp_plugin)    set(CHEMSI_GRPC_CPP_PLUGIN_TARGET gRPC::grpc_cpp_plugin)    set(CHEMSI_GRPC_CPP_PLUGIN_EXE $<TARGET_FILE:gRPC::grpc_cpp_plugin>)  endif()  if (CHEMSI_GRPC_CPP_PLUGIN_TARGET STREQUAL "")    message(FATAL_ERROR "grpc_cpp_plugin target not found. Ensure gRPC is available via CMake (system package or FetchContent).")  endif()  if (NOT TARGET protobuf::protoc)    message(FATAL_ERROR "protobuf::protoc target not found. Ensure Protobuf is available via CMake (system package or FetchContent).")  endif()  set(CHEMSI_PROTO_DIR ${CMAKE_SOURCE_DIR}/../proto)  set(CHEMSI_PROTO_GEN_DIR ${CMAKE_BINARY_DIR}/generated)  file(MAKE_DIRECTORY ${CHEMSI_PROTO_GEN_DIR})  set(CHEMSI_PROTO_FILES    ${CHEMSI_PROTO_DIR}/vfep_types_v1.proto    ${CHEMSI_PROTO_DIR}/world_snapshot_v1.proto    ${CHEMSI_PROTO_DIR}/telemetry_frame_v1.proto    ${CHEMSI_PROTO_DIR}/command_v1.proto    ${CHEMSI_PROTO_DIR}/vfep_sim_service_v1.proto  )  # Generate C++ sources  set(CHEMSI_PROTO_SRCS "")  set(CHEMSI_PROTO_HDRS "")  foreach(proto ${CHEMSI_PROTO_FILES})    get_filename_component(proto_name ${proto} NAME_WE)    list(APPEND CHEMSI_PROTO_SRCS ${CHEMSI_PROTO_GEN_DIR}/${proto_name}.pb.cc)    list(APPEND CHEMSI_PROTO_HDRS ${CHEMSI_PROTO_GEN_DIR}/${proto_name}.pb.h)  endforeach()  # Service proto generates gRPC stubs  set(CHEMSI_GRPC_SRCS    ${CHEMSI_PROTO_GEN_DIR}/vfep_sim_service_v1.grpc.pb.cc  )  set(CHEMSI_GRPC_HDRS    ${CHEMSI_PROTO_GEN_DIR}/vfep_sim_service_v1.grpc.pb.h  )  add_custom_command(    OUTPUT ${CHEMSI_PROTO_SRCS} ${CHEMSI_PROTO_HDRS} ${CHEMSI_GRPC_SRCS} ${CHEMSI_GRPC_HDRS}    COMMAND protobuf::protoc    ARGS      -I ${CHEMSI_PROTO_DIR}      --cpp_out=${CHEMSI_PROTO_GEN_DIR}      --grpc_out=${CHEMSI_PROTO_GEN_DIR}      --plugin=protoc-gen-grpc=${CHEMSI_GRPC_CPP_PLUGIN_EXE}      ${CHEMSI_PROTO_FILES}    DEPENDS ${CHEMSI_PROTO_FILES} protobuf::protoc ${CHEMSI_GRPC_CPP_PLUGIN_TARGET}    COMMENT "Generating protobuf/gRPC sources"    VERBATIM  )  add_library(chemsi_grpc_proto    ${CHEMSI_PROTO_SRCS}    ${CHEMSI_GRPC_SRCS}  )  target_include_directories(chemsi_grpc_proto PUBLIC ${CHEMSI_PROTO_GEN_DIR})  target_link_libraries(chemsi_grpc_proto PUBLIC protobuf::libprotobuf gRPC::grpc++)  target_compile_definitions(chemsi PUBLIC CHEMSI_ENABLE_GRPC=1)  target_include_directories(chemsi PUBLIC ${CHEMSI_PROTO_GEN_DIR})  target_link_libraries(chemsi PUBLIC chemsi_grpc_proto)endif()endif()# ============================================================# Main simulation (console)# ============================================================add_executable(VFEP_Sim src/main.cpp)target_link_libraries(VFEP_Sim PRIVATE chemsi)add_executable(VFEP_GrpcClient src/grpc_client.cpp)target_link_libraries(VFEP_GrpcClient PRIVATE chemsi)# ============================================================# Tests# ============================================================enable_testing()add_executable(TestAtom tests/TestAtom.cpp)target_link_libraries(TestAtom PRIVATE chemsi)add_test(NAME TestAtom COMMAND TestAtom)add_executable(NumericIntegrity tests/TestNumericIntegrity.cpp)target_link_libraries(NumericIntegrity PRIVATE chemsi)add_test(NAME NumericIntegrity COMMAND NumericIntegrity)# ---------------------------------------------------------------------------# MSVC Debug stack overflow fix for NumericIntegrity## Your Debug run exits with -1073741571 (0xC00000FD = STATUS_STACK_OVERFLOW),# which stops execution before reaching 3B1 / 3B2.## MSVC Debug builds have higher stack usage than Release (less inlining/opts,# more debug instrumentation). Increase stack reserve for this test binary.## If 8MB is not enough, change to 16777216 (16MB).# ---------------------------------------------------------------------------if (MSVC)  target_link_options(NumericIntegrity PRIVATE "$<$<CONFIG:Debug>:/STACK:8388608>")endif()# ============================================================# Visualization executable: GLFW + OpenGL + ImGui (+ ImPlot)# ============================================================if (CHEMSI_BUILD_VIS)  include(FetchContent)  # --- OpenGL (platform-correct target: OpenGL::GL) ---  find_package(OpenGL REQUIRED)  # --- GLFW (CMake project; provides target "glfw") ---  set(GLFW_BUILD_DOCS OFF CACHE BOOL "" FORCE)  set(GLFW_BUILD_EXAMPLES OFF CACHE BOOL "" FORCE)  set(GLFW_BUILD_TESTS OFF CACHE BOOL "" FORCE)  set(GLFW_INSTALL OFF CACHE BOOL "" FORCE)  FetchContent_Declare(    glfw    GIT_REPOSITORY https://github.com/glfw/glfw.git    GIT_TAG        3.4  )  FetchContent_MakeAvailable(glfw)  # --- Dear ImGui ---  FetchContent_Declare(    imgui    GIT_REPOSITORY https://github.com/ocornut/imgui.git    GIT_TAG        v1.91.1  )  FetchContent_MakeAvailable(imgui)  # --- ImPlot ---  FetchContent_Declare(    implot    GIT_REPOSITORY https://github.com/epezent/implot.git    GIT_TAG        v0.16  )  FetchContent_MakeAvailable(implot)  # --- UI static library (ImGui + backends + ImPlot) ---  add_library(imgui_lib STATIC    ${imgui_SOURCE_DIR}/imgui.cpp    ${imgui_SOURCE_DIR}/imgui_draw.cpp    ${imgui_SOURCE_DIR}/imgui_tables.cpp    ${imgui_SOURCE_DIR}/imgui_widgets.cpp    # ${imgui_SOURCE_DIR}/imgui_demo.cpp    ${imgui_SOURCE_DIR}/backends/imgui_impl_glfw.cpp    ${imgui_SOURCE_DIR}/backends/imgui_impl_opengl3.cpp    ${implot_SOURCE_DIR}/implot.cpp    ${implot_SOURCE_DIR}/implot_items.cpp    # ${implot_SOURCE_DIR}/implot_demo.cpp  )  target_include_directories(imgui_lib PUBLIC    ${imgui_SOURCE_DIR}    ${imgui_SOURCE_DIR}/backends    ${implot_SOURCE_DIR}  )  target_link_libraries(imgui_lib PUBLIC    glfw    OpenGL::GL  )  # Optional: define an OpenGL loader if your environment requires it.  # target_compile_definitions(imgui_lib PRIVATE IMGUI_IMPL_OPENGL_LOADER_GL3W)  # --- Visualizer executable ---  add_executable(VFEP_Vis    vis/main_vis.cpp  )  # Produce VFEP.exe instead of VFEP_Vis.exe (keeps target name stable)  set_target_properties(VFEP_Vis PROPERTIES OUTPUT_NAME "VFEP")  target_link_libraries(VFEP_Vis PRIVATE    chemsi    imgui_lib  )  target_include_directories(VFEP_Vis PRIVATE    ${CMAKE_SOURCE_DIR}/include    ${CMAKE_SOURCE_DIR}/vis  )endif()